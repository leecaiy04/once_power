name: Build AppImage

on:
  push:
    # å½“æŽ¨é€åˆ° release åˆ†æ”¯æˆ–åˆ›å»º tag æ—¶è§¦å‘
    branches: [ release ]
    tags: [ 'v*.*.*' ]
  pull_request:
    branches: [ release ]

jobs:
  build_appimage:
    # å…³é”®ï¼šä½¿ç”¨è¾ƒæ–°çš„ Runnerï¼Œä¾‹å¦‚ Ubuntu 22.04ï¼Œä»¥èŽ·å–æ–°çš„ GLIBC/GLIBCXX
    runs-on: ubuntu-22.04 

    steps:
      - name: â¬‡ï¸ Checkout ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        
      # --- å‡è®¾æ‚¨çš„åº”ç”¨ç¨‹åºéœ€è¦å…ˆç¼–è¯‘ï¼ˆå¦‚æžœç¨‹åºåœ¨ä»“åº“ä¸­æ˜¯æºç ï¼‰ ---
      # å¦‚æžœæ‚¨çš„ç¨‹åºå·²ç»é¢„ç¼–è¯‘å¥½ï¼Œå¹¶ä¸”åœ¨ä»“åº“ä¸­ï¼Œå¯ä»¥è·³è¿‡ç¼–è¯‘æ­¥éª¤ã€‚
      # - name: ðŸ› ï¸ å®‰è£…æž„å»ºä¾èµ–
      #   run: |
      #     sudo apt-get update
      #     sudo apt-get install -y build-essential cmake pkg-config
      # - name: âš™ï¸ ç¼–è¯‘ç¨‹åº
      #   run: |
      #     # ã€è¯·ä¿®æ”¹ã€‘è¿™é‡Œæ›¿æ¢ä¸ºæ‚¨çš„å®žé™…ç¼–è¯‘å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š
      #     # mkdir build && cd build
      #     # cmake ..
      #     # make -j$(nproc)
      
      # âš ï¸ å…³é”®æ­¥éª¤ï¼šè®¾ç½® AppDir
      # å‡è®¾æ‚¨å·²ç»æœ‰ä¸€ä¸ª AppDir ç›®å½•ï¼Œæˆ–è€…æ‚¨éœ€è¦æ‰‹åŠ¨å¤åˆ¶æ–‡ä»¶åˆ° AppDir
      - name: ðŸ“‚ è®¾ç½® AppDir ç›®å½•ç»“æž„
        run: |
          APP_NAME="once-power" # ã€è¯·ä¿®æ”¹ã€‘æ‚¨çš„åº”ç”¨åç§°
          APPDIR="${{ runner.temp }}/AppDir"
          mkdir -p "$APPDIR/usr/bin"
          mkdir -p "$APPDIR/usr/lib"
          
          # ã€è¯·ä¿®æ”¹ã€‘å°†æ‚¨çš„ä¸»å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ° usr/bin
          # å‡è®¾ä¸»ç¨‹åºæ˜¯ /path/to/once-power-executable
          # cp /path/to/once-power-executable "$APPDIR/usr/bin/$APP_NAME"

          # ã€è¯·ä¿®æ”¹ã€‘å°†æ‚¨çš„ libfvp_plugin.so å’Œå…¶ä»–è¿è¡Œæ—¶åº“å¤åˆ¶åˆ° usr/lib
          # æ³¨æ„ï¼šAppImage ä¼šè‡ªåŠ¨å¤„ç†å¤§éƒ¨åˆ†æ ‡å‡†åº“ï¼Œä½†æœ€å¥½æŠŠåº”ç”¨ç‰¹å®šçš„åº“æ”¾è¿›åŽ»
          # cp -r /data/opt/once-power/lib/* "$APPDIR/usr/lib/"
          
          # åˆ›å»º .desktop æ–‡ä»¶å’Œå›¾æ ‡ (AppImage å¿…éœ€)
          cat > "$APPDIR/$APP_NAME.desktop" << EOF
          [Desktop Entry]
          Name=$APP_NAME
          Exec=$APP_NAME
          Icon=$APP_NAME # ã€è¯·ä¿®æ”¹ã€‘è¯·ç¡®ä¿æ‚¨çš„å›¾æ ‡æ–‡ä»¶ (ä¾‹å¦‚ .png) åœ¨ AppDir/usr/share/icons/hicolor/
          Type=Application
          Categories=Utility;
          EOF
          
      # --- ä½¿ç”¨ linuxdeploy æ‰“åŒ… ---
      - name: â¬‡ï¸ ä¸‹è½½ linuxdeploy å·¥å…·
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-appimage/releases/download/continuous/linuxdeploy-plugin-appimage-x86_64.AppImage
          chmod +x linuxdeploy*.AppImage
          
      - name: âš™ï¸ æ‰§è¡Œ AppImage æ‰“åŒ…
        run: |
          ./linuxdeploy-x86_64.AppImage \
            --appdir "${{ runner.temp }}/AppDir" \
            --executable "${{ runner.temp }}/AppDir/usr/bin/once-power" \
            --output appimage
            
      - name: ðŸ“¤ ä¸Šä¼  AppImage æ–‡ä»¶åˆ° Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-AppImage
          path: '*.AppImage'
          
      # å¯é€‰ï¼šå‘å¸ƒåˆ° GitHub Release
      - name: ðŸš€ å‘å¸ƒåˆ° GitHub Release (å¦‚æžœ tag å­˜åœ¨)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: '*.AppImage'
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false

name: Build Once-Power AppImage

on:
  push:
    # ä»…åœ¨æŽ¨é€åˆ° main åˆ†æ”¯æˆ–åˆ›å»º Tag æ—¶è¿è¡Œ
    branches: [ main ]
    tags: [ 'v*.*.*' ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build_appimage:
    # è§£å†³ GLIBC ç‰ˆæœ¬ä¾èµ–é—®é¢˜çš„å…³é”®ï¼šä½¿ç”¨è¾ƒæ–°çš„ Ubuntu ç³»ç»Ÿ
    runs-on: ubuntu-22.04 

    env:
      APP_NAME: OncePower             # åº”ç”¨æ˜¾ç¤ºåç§°
      EXECUTABLE_NAME: once-power-main # ã€å·²ä¿®æ”¹ã€‘ä¸»å¯æ‰§è¡Œæ–‡ä»¶çš„æ–‡ä»¶å
      APPDIR: ${{ runner.temp }}/AppDir

    steps:
      - name: â¬‡ï¸ Checkout ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      # --- ç¼–è¯‘å’Œè®¾ç½® AppDir ç»“æž„ ---
      
      - name: ðŸ› ï¸ ç¼–è¯‘å’Œè®¾ç½® AppDir ç»“æž„
        run: |
          # 1. å®‰è£…å¿…è¦çš„æž„å»ºä¾èµ– (æ­¤å¤„å‡è®¾æ‚¨çš„åº”ç”¨ä¾èµ– libgtk-3, build-essential)
          echo "å®‰è£…æž„å»ºä¾èµ–..."
          sudo apt-get update
          # æ·»åŠ æ‰€æœ‰æ‚¨éœ€è¦çš„ä¾èµ–ï¼Œä¾‹å¦‚ï¼š
          sudo apt-get install -y build-essential cmake pkg-config libgtk-3-dev
          
          # 2. ã€å·²ä¿®æ”¹ã€‘æ‰§è¡Œæ‚¨çš„ç¼–è¯‘å’Œæž„å»ºå‘½ä»¤
          echo "æ‰§è¡Œç¼–è¯‘..."
          
          # å‡è®¾ä½¿ç”¨ CMake è¿›è¡Œç¼–è¯‘
          # è¯·æ ¹æ®æ‚¨çš„å®žé™…æž„å»ºæµç¨‹è°ƒæ•´æˆ–å–æ¶ˆæ³¨é‡Šä»¥ä¸‹å‘½ä»¤
          # mkdir build-release
          # cmake -S . -B build-release 
          # make -C build-release -j$(nproc)
          
          # 3. --- AppDir æ–‡ä»¶å‡†å¤‡ (æ ¸å¿ƒæ­¥éª¤) ---
          
          echo "åˆ›å»º AppDir ç›®å½•: $APPDIR"
          mkdir -p $APPDIR/usr/bin
          mkdir -p $APPDIR/usr/lib
          mkdir -p $APPDIR/usr/share/icons/hicolor/256x256/apps
          
          # 4. ã€å·²ä¿®æ”¹ã€‘å¤åˆ¶ä¸»å¯æ‰§è¡Œæ–‡ä»¶
          # å‡è®¾ä¸»å¯æ‰§è¡Œæ–‡ä»¶åœ¨ ./build/bin/
          echo "å¤åˆ¶ä¸»å¯æ‰§è¡Œæ–‡ä»¶..."
          cp ./build/bin/${{ env.EXECUTABLE_NAME }} $APPDIR/usr/bin/${{ env.EXECUTABLE_NAME }} 
          
          # 5. ã€å·²ä¿®æ”¹ã€‘å¤åˆ¶æ‰€æœ‰åº”ç”¨ä¸“æœ‰åº“ (.so æ–‡ä»¶)ï¼ŒåŒ…æ‹¬ libfvp_plugin.so
          # å‡è®¾åº“æ–‡ä»¶åœ¨ ./build/lib/ ç›®å½•ä¸‹
          echo "å¤åˆ¶åº”ç”¨åº“æ–‡ä»¶ (å¦‚ libfvp_plugin.so)..."
          cp ./build/lib/libfvp_plugin.so $APPDIR/usr/lib/
          cp ./build/lib/libmdk.so.0 $APPDIR/usr/lib/ # å¤åˆ¶å…¶ä»–å®šåˆ¶åº“
          
          # 6. åˆ›å»º .desktop æ–‡ä»¶ (AppImage å¿…éœ€)
          echo "åˆ›å»º .desktop æ–‡ä»¶..."
          cat > "$APPDIR/${{ env.APP_NAME }}.desktop" << EOF
          [Desktop Entry]
          Name=${{ env.APP_NAME }}
          Exec=${{ env.EXECUTABLE_NAME }}
          Icon=${{ env.APP_NAME }}
          Type=Application
          Categories=Utility;
          EOF
          
          # 7. ã€å·²ä¿®æ”¹ã€‘å¤åˆ¶å›¾æ ‡æ–‡ä»¶ (å‡è®¾å›¾æ ‡åä¸º icon.pngï¼Œä½äºŽ resources/)
          echo "å¤åˆ¶å›¾æ ‡æ–‡ä»¶..."
          cp ./resources/icon.png $APPDIR/usr/share/icons/hicolor/256x256/apps/${{ env.APP_NAME }}.png

      # --- AppImage æ‰“åŒ…æ­¥éª¤ï¼šä½¿ç”¨ linuxdeploy è‡ªåŠ¨æ†ç»‘ç³»ç»Ÿä¾èµ– ---
      
      - name: â¬‡ï¸ ä¸‹è½½ linuxdeploy å·¥å…·å’Œ AppImage æ’ä»¶
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-appimage/releases/download/continuous/linuxdeploy-plugin-appimage-x86_64.AppImage
          chmod +x linuxdeploy*.AppImage

      - name: âš™ï¸ æ‰§è¡Œ AppImage æ‰“åŒ… (æ†ç»‘ä¾èµ–åº“)
        run: |
          echo "å¼€å§‹æ‰“åŒ… AppImage..."
          ./linuxdeploy-x86_64.AppImage \
            --appdir "$APPDIR" \
            --executable "$APPDIR/usr/bin/${{ env.EXECUTABLE_NAME }}" \
            --desktop-file "$APPDIR/${{ env.APP_NAME }}.desktop" \
            --output appimage
          
          # é‡å‘½åæ–‡ä»¶ä»¥ä¾¿äºŽè¯†åˆ«
          mv *.AppImage ${{ env.APP_NAME }}-${{ github.sha }}.AppImage

      - name: ðŸ“¤ ä¸Šä¼ ç”Ÿæˆçš„ AppImage æ–‡ä»¶åˆ° Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: AppImage-Build-Artifact
          path: '*.AppImage'

      - name: ðŸš€ å‘å¸ƒ AppImage åˆ° GitHub Release (å¦‚æžœä½¿ç”¨ Tag è§¦å‘)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: '*.AppImage'
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false

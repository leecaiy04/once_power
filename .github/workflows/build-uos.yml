name: Build & Release for UOS

on:
  workflow_dispatch: # 手动触发

permissions:
  contents: write # 必须赋予写权限，否则无法创建 Release

jobs:
  # 第一步：在老旧系统环境下编译（为了兼容 UOS）
  build:
    runs-on: ubuntu-latest
    container:
      image: debian:buster # 使用 Debian 10 保证 glibc 版本够老
    
    steps:
    - name: Install Build Dependencies
      run: |
        apt-get update
        apt-get install -y git curl unzip xz-utils zip libglu1-mesa clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-8-dev
        
    - name: Mark Git Directory Safe
      run: git config --global --add safe.directory '*'

    - uses: actions/checkout@v4

    - name: Install Flutter Manually
      run: |
        git clone https://github.com/flutter/flutter.git -b stable /opt/flutter
        echo "/opt/flutter/bin" >> $GITHUB_PATH

    - name: Fix Permissions & Get Packages
      run: |
        git config --global --add safe.directory /opt/flutter
        flutter config --no-analytics
        flutter pub get

    - name: Build Linux Release
      run: flutter build linux --release

    - name: Package for UOS
      run: |
        APP_NAME="once_power"
        PKG_NAME="com.ilgnefz.oncepower"
        VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //')
        
        # 创建目录结构
        mkdir -p package/DEBIAN
        mkdir -p package/opt/apps/$PKG_NAME/files
        mkdir -p package/usr/share/applications
        mkdir -p package/usr/share/icons/hicolor/512x512/apps

        # 查找并复制编译产物
        BUILD_DIR=$(find build -type f -name "$APP_NAME" | grep "release/bundle" | xargs dirname)
        cp -r $BUILD_DIR/* package/opt/apps/$PKG_NAME/files/
        
        # ⚠️ 赋予执行权限
        chmod +x package/opt/apps/$PKG_NAME/files/$APP_NAME

        # 处理图标
        if [ -f "assets/images/logo.png" ]; then
          cp assets/images/logo.png package/usr/share/icons/hicolor/512x512/apps/$PKG_NAME.png
        elif [ -f "assets/logo.png" ]; then
          cp assets/logo.png package/usr/share/icons/hicolor/512x512/apps/$PKG_NAME.png
        else
          touch package/usr/share/icons/hicolor/512x512/apps/$PKG_NAME.png
        fi

        # 创建 desktop 文件
        cat <<EOF > package/usr/share/applications/$PKG_NAME.desktop
        [Desktop Entry]
        Version=1.0
        Type=Application
        Name=OncePower
        Name[zh_CN]=OncePower
        Comment=Batch file renaming tool
        Exec=/opt/apps/$PKG_NAME/files/$APP_NAME
        Icon=$PKG_NAME
        Terminal=false
        Categories=Utility;
        EOF

        # 创建 control 文件
        cat <<EOF > package/DEBIAN/control
        Package: $PKG_NAME
        Version: $VERSION
        Section: utils
        Priority: optional
        Architecture: amd64
        Depends: libgtk-3-0, libc6, libstdc++6, libmpv1
        Maintainer: GithubAction
        Description: Batch renaming tool for UOS.
        EOF
        
        chmod 755 -R package/DEBIAN

    - name: Build Deb File
      run: |
        VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //')
        # 构建 deb
        dpkg-deb --build package once_power_${VERSION}_uos_legacy.deb
        # 将版本号写入文件，传递给下一个任务
        echo "$VERSION" > version.txt

    - name: Upload Artifact for Release
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          *.deb
          version.txt

  # 第二步：发布到 GitHub Releases 页面
  release:
    needs: build # 等待构建完成
    runs-on: ubuntu-latest
    
    steps:
    - name: Download Artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts

    - name: Read Version
      id: get_version
      run: |
        ver=$(cat version.txt)
        echo "VERSION=$ver" >> $GITHUB_ENV

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ env.VERSION }}
        name: Release v${{ env.VERSION }} (UOS Support)
        draft: false
        prerelease: false
        files: |
          *.deb
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: Build Linux App

on:
  workflow_dispatch:
  push:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Linux Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libayatana-appindicator3-dev

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      - name: Enable Linux Configuration
        run: |
          flutter config --enable-linux-desktop
          flutter create --platforms=linux .

      - name: Get Dependencies
        run: flutter pub get

      - name: Build Linux App
        run: flutter build linux --release

      # 制作 DEB 安装包
      - name: Package as Deb
        run: |
          APP_NAME="once-power"
          VERSION="1.0.0"
          ARCH="amd64"
          
          mkdir -p deb_package/DEBIAN
          mkdir -p deb_package/usr/local/bin
          mkdir -p deb_package/opt/$APP_NAME
          mkdir -p deb_package/usr/share/applications

          cp -r build/linux/x64/release/bundle/* deb_package/opt/$APP_NAME/

          echo "#!/bin/bash" > deb_package/usr/local/bin/$APP_NAME
          echo "/opt/$APP_NAME/once_power" >> deb_package/usr/local/bin/$APP_NAME
          chmod +x deb_package/usr/local/bin/$APP_NAME

          cat > deb_package/usr/share/applications/$APP_NAME.desktop <<EOF
          [Desktop Entry]
          Version=1.0
          Type=Application
          Name=Once Power
          Comment=Batch file rename and management tool
          Exec=/opt/$APP_NAME/once_power
          Icon=$APP_NAME
          Terminal=false
          Categories=Utility;
          EOF

          cat > deb_package/DEBIAN/control <<EOF
          Package: $APP_NAME
          Version: $VERSION
          Architecture: $ARCH
          Maintainer: You <your@email.com>
          Description: Once Power - File batch processing tool
           A Flutter based tool for batch file renaming and management.
          EOF

          # [重要修复] 添加 -Zxz 参数，强制使用兼容性更好的 xz 压缩
          dpkg-deb --build -Zxz deb_package ${APP_NAME}_${VERSION}_${ARCH}.deb

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux_release_files
          path: |
            *.deb
            build/linux/x64/release/bundle/

name: Build AppImage

on:
  push:
    # ä»…åœ¨æŽ¨é€åˆ° main æˆ– master åˆ†æ”¯æ—¶è¿è¡Œï¼Œæˆ–è€…åœ¨åˆ›å»º Release Tag æ—¶è¿è¡Œ
    branches: [ main, master ]
    tags: [ 'v*.*.*' ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build_appimage:
    # å…³é”®ï¼šä½¿ç”¨ Ubuntu 22.04 ä½œä¸ºæž„å»ºçŽ¯å¢ƒï¼Œå®ƒåŒ…å«è¾ƒæ–°çš„ GLIBC (2.35+)
    runs-on: ubuntu-22.04 

    env:
      APP_NAME: once-power # ã€å¿…é¡»ä¿®æ”¹ã€‘æ‚¨çš„åº”ç”¨çš„ä¸»åç§°
      EXECUTABLE_NAME: once-power-main # ã€å¿…é¡»ä¿®æ”¹ã€‘æ‚¨çš„ä¸»å¯æ‰§è¡Œæ–‡ä»¶åç§°
      APPDIR: ${{ runner.temp }}/AppDir

    steps:
      - name: â¬‡ï¸ Checkout ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      # --- ç¼–è¯‘/å‡†å¤‡åº”ç”¨ç¨‹åºçš„äºŒè¿›åˆ¶æ–‡ä»¶ ---
      # **æ³¨æ„:** è¿™ä¸€æ­¥æ˜¯å‡è®¾æ‚¨éœ€è¦ä»Žæºç ç¼–è¯‘ã€‚å¦‚æžœæ‚¨çš„äºŒè¿›åˆ¶æ–‡ä»¶å·²ç»å­˜åœ¨äºŽä»“åº“ä¸­ï¼Œè¯·ä¿®æ”¹æ­¤æ­¥éª¤ã€‚
      - name: ðŸ› ï¸ ç¼–è¯‘å’Œå®‰è£…åº”ç”¨åˆ° AppDir
        run: |
          # 1. å®‰è£…å¿…è¦çš„æž„å»ºä¾èµ– (æ ¹æ®æ‚¨çš„é¡¹ç›®è°ƒæ•´)
          sudo apt-get update
          # sudo apt-get install -y cmake build-essential libgtk-3-dev ...

          # 2. ã€å¿…é¡»ä¿®æ”¹ã€‘æ‰§è¡Œæ‚¨çš„ç¼–è¯‘å’Œæž„å»ºå‘½ä»¤
          # å‡è®¾æ‚¨çš„é¡¹ç›®æ˜¯ç”¨ CMake æž„å»ºçš„ï¼Œå¹¶å°†æ–‡ä»¶å®‰è£…åˆ° $APPDIR
          # cmake -B build -DCMAKE_INSTALL_PREFIX=/usr
          # cmake --build build --target install --prefix $APPDIR

          # âš ï¸ ç¤ºä¾‹ï¼šå¦‚æžœæ‚¨çš„äºŒè¿›åˆ¶æ–‡ä»¶å’Œåº“æ–‡ä»¶å·²ç»å­˜åœ¨äºŽä¸€ä¸ªè·¯å¾„ä¸­ (ä¾‹å¦‚ï¼š/data/opt/once-power)
          # æ‚¨éœ€è¦å°†è¿™äº›æ–‡ä»¶ä»Žä»“åº“çš„æŸä¸ªä½ç½®å¤åˆ¶è¿‡æ¥ã€‚
          
          # **é‡è¦ï¼š** å¿…é¡»ç¡®ä¿å°†æ ¸å¿ƒå¯æ‰§è¡Œæ–‡ä»¶å’Œæ‰€æœ‰ **once-power è‡ªå·±çš„åº“** å¤åˆ¶åˆ° AppDir
          # ç¤ºä¾‹ï¼šå°†æ‚¨çš„æ‰€æœ‰æ–‡ä»¶ (åŒ…æ‹¬ libfvp_plugin.so) å¤åˆ¶åˆ° /usr/lib å’Œ /usr/bin ä¸‹
          mkdir -p $APPDIR/usr/bin $APPDIR/usr/lib $APPDIR/usr/share/icons/hicolor/256x256/apps
          
          # ã€å‡è®¾ã€‘æ‚¨çš„ä¸»å¯æ‰§è¡Œæ–‡ä»¶åœ¨ä»“åº“çš„æŸä¸ªä½ç½®ï¼Œå°†å…¶å¤åˆ¶åˆ° AppDir/usr/bin
          # cp path/to/your/main_executable $APPDIR/usr/bin/${{ env.EXECUTABLE_NAME }} 

          # ã€å‡è®¾ã€‘æ‚¨çš„ libfvp_plugin.so å’Œ libmdk.so.0 ç­‰åœ¨ä»“åº“çš„æŸä¸ªä½ç½®ï¼Œå°†å…¶å¤åˆ¶åˆ° AppDir/usr/lib
          # cp path/to/your/libfvp_plugin.so $APPDIR/usr/lib/
          # cp path/to/your/libmdk.so.0 $APPDIR/usr/lib/
          
          # 3. åˆ›å»º .desktop æ–‡ä»¶ (AppImage å¿…éœ€)
          cat > "$APPDIR/${{ env.APP_NAME }}.desktop" << EOF
          [Desktop Entry]
          Name=${{ env.APP_NAME }}
          Exec=${{ env.EXECUTABLE_NAME }} # ä½¿ç”¨ä¸Šé¢å¤åˆ¶çš„ä¸»å¯æ‰§è¡Œæ–‡ä»¶åç§°
          Icon=${{ env.APP_NAME }}
          Type=Application
          Categories=Utility;
          EOF
          
          # 4. ã€å¿…é¡»ä¿®æ”¹ã€‘å¤åˆ¶å›¾æ ‡æ–‡ä»¶ (å‡è®¾å›¾æ ‡åä¸º once-power.png)
          # cp path/to/your/once-power.png $APPDIR/usr/share/icons/hicolor/256x256/apps/${{ env.APP_NAME }}.png

      # --- AppImage æ‰“åŒ…æ­¥éª¤ ---
      
      - name: â¬‡ï¸ ä¸‹è½½ linuxdeploy å·¥å…·å’Œ AppImage æ’ä»¶
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-appimage/releases/download/continuous/linuxdeploy-plugin-appimage-x86_64.AppImage
          chmod +x linuxdeploy*.AppImage

      - name: âš™ï¸ æ‰§è¡Œ AppImage æ‰“åŒ… (æ†ç»‘ä¾èµ–åº“)
        run: |
          ./linuxdeploy-x86_64.AppImage \
            --appdir "$APPDIR" \
            --executable "$APPDIR/usr/bin/${{ env.EXECUTABLE_NAME }}" \
            --desktop-file "$APPDIR/${{ env.APP_NAME }}.desktop" \
            --output appimage
            
      - name: ðŸ“¤ ä¸Šä¼ ç”Ÿæˆçš„ AppImage æ–‡ä»¶åˆ° Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-AppImage
          path: '*.AppImage' # åŒ¹é…å½“å‰ç›®å½•ä¸‹ç”Ÿæˆçš„æ‰€æœ‰ AppImage æ–‡ä»¶

      - name: ðŸš€ å‘å¸ƒ AppImage åˆ° GitHub Release (å¦‚æžœä½¿ç”¨ Tag è§¦å‘)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: '*.AppImage'
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
